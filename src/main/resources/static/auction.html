<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹¤ì‹œê°„ ê²½ë§¤ë°©</title>
    <style>
        #paymentModal {
            display: none;
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border: 2px solid #333;
            z-index: 9999;
        }
        #overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
        }
    </style>
</head>
<body>
<h2>ê²½ë§¤ë°© #1</h2>
<input type="text" id="username" placeholder="ìµëª… ì´ë¦„ ì…ë ¥" />
<input type="number" id="amount" placeholder="ì…ì°°ê°€ ì…ë ¥" />
<button onclick="sendBid()">ì…ì°°</button>

<ul id="messages"></ul>

<!-- ê²°ì œ ëª¨ë‹¬ -->
<div id="overlay"></div>
<div id="paymentModal">
    <h3 id="paymentTitle">ê²°ì œ ìš”ì²­</h3>
    <p id="paymentAmount"></p>
    <button onclick="confirmPayment()">ê²°ì œ ì§„í–‰</button>
    <button onclick="closePaymentModal()">ë‹«ê¸°</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    // // 1ï¸âƒ£ URLì—ì„œ auctionId ë°›ì•„ì˜¤ê¸°
    // const urlParams = new URLSearchParams(window.location.search);
    // const auctionId = urlParams.get("auctionId");
    // console.log("ğŸ” URLì—ì„œ ë°›ì€ auctionId:", auctionId);
    //
    // if (!auctionId) {
    //     alert("ê²½ë§¤ IDê°€ URLì— ì—†ìŠµë‹ˆë‹¤.");
    //     throw new Error("auctionId is missing from URL.");
    // }

    // 2ï¸âƒ£ ì†Œì¼“ ì—°ê²°
    const socket = new SockJS("/ws-stomp");
    const stompClient = Stomp.over(socket);
    const auctionId = 1;

    stompClient.connect({}, function () {
        console.log("âœ… ì›¹ì†Œì¼“ ì—°ê²° ì„±ê³µ!");

        // 3ï¸âƒ£ ì…ì¥ ìš”ì²­
        const username = document.getElementById("username").value;
        stompClient.send(`/pub/auction/${auctionId}/enter`, {}, JSON.stringify({ username }));
        console.log("ğŸšª ì…ì¥ ìš”ì²­ ì „ì†¡ë¨");

        // 4ï¸âƒ£ ì…ì°° ìˆ˜ì‹ 
        stompClient.subscribe(`/topic/auction/${auctionId}`, function (message) {
            const bid = JSON.parse(message.body);
            const li = document.createElement("li");
            li.innerText = `${bid.username}ë‹˜ì´ ${bid.amount}ì› ì…ì°°!`;
            document.getElementById("messages").appendChild(li);
        });

        // 5ï¸âƒ£ ì—ëŸ¬ ìˆ˜ì‹ 
        stompClient.subscribe("/user/queue/errors", function (error) {
            alert("âŒ ì—ëŸ¬: " + error.body);
        });

        // 6ï¸âƒ£ ë‚™ì°°ì ê²°ì œ ìš”ì²­ ìˆ˜ì‹ 
        stompClient.subscribe("/user/queue/bid-result", function (message) {
            const data = JSON.parse(message.body);
            if (data.type === "WINNER") {
                showPaymentModal(data.amount);
            }
        });
    });

    // 7ï¸âƒ£ ì…ì°° ì „ì†¡
    function sendBid() {
        const username = document.getElementById("username").value;
        const amount = document.getElementById("amount").value;

        console.log("ğŸ“¤ ì…ì°° ìš”ì²­:", username, amount);

        if (!username || !amount) {
            alert("ë‹‰ë„¤ì„ê³¼ ì…ì°°ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        const bid = {
            username: username,
            amount: parseInt(amount)
        };

        stompClient.send(`/pub/auction/${auctionId}/bid`, {}, JSON.stringify(bid));
        console.log("ğŸ“¤ ì…ì°° ì „ì†¡ë¨:", bid);
    }

    // 8ï¸âƒ£ ê²°ì œ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
    function showPaymentModal(amount) {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("paymentModal").style.display = "block";
        document.getElementById("paymentAmount").innerText = `${amount}ì›ì— ë‚™ì°°ë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ì œë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.`;
    }

    function closePaymentModal() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("paymentModal").style.display = "none";
    }

    function confirmPayment() {
        alert("ê²°ì œ API í˜¸ì¶œë¨ (ì¶”í›„ êµ¬í˜„ ì˜ˆì •)");
        closePaymentModal();
    }
</script>
</body>
</html>
